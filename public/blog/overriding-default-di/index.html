<!DOCTYPE HTML>

<html>
    <head>
        <link rel="icon" href="/img/main/favicon.png" type="image/png" />
        <link rel="shortcut icon" href="/favicon.ico" />
        
            
                <title>Overriding ASP.NET Core Framework-Provided Services</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.55.6" />
        


        
            <meta name="author" content="David Pine">
        
        
            <meta name="description" content="You take the red pill—you stay in Wonderland, and I show you how deep the rabbit hole goes">
        

        <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://davidpine.net/img/2017/02/red-or-blue-pill-matrix-neo-morpheus.jpg"/>

<meta name="twitter:title" content="Overriding ASP.NET Core Framework-Provided Services"/>
<meta name="twitter:description" content="You take the red pill—you stay in Wonderland, and I show you how deep the rabbit hole goes"/>
<meta name="twitter:site" content="@davidpine7"/>

        <meta property="og:title" content="Overriding ASP.NET Core Framework-Provided Services" />
<meta property="og:description" content="You take the red pill—you stay in Wonderland, and I show you how deep the rabbit hole goes" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://davidpine.net/blog/overriding-default-di/" />

<meta property="og:image" content="https://davidpine.net/img/2017/02/red-or-blue-pill-matrix-neo-morpheus.jpg" />
<meta property="article:published_time" content="2017-02-14T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2017-02-14T00:00:00&#43;00:00"/>

        
<meta itemprop="name" content="Overriding ASP.NET Core Framework-Provided Services">
<meta itemprop="description" content="You take the red pill—you stay in Wonderland, and I show you how deep the rabbit hole goes">


<meta itemprop="datePublished" content="2017-02-14T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2017-02-14T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="813">

  <meta itemprop="image" content="https://davidpine.net/img/2017/02/red-or-blue-pill-matrix-neo-morpheus.jpg">



<meta itemprop="keywords" content="" />

        

        

        
        
            
        
        
        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/tomorrow-night.css">
        

        

        
        
        
            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-78203613-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

        
    
        <link rel="stylesheet" href="/css/justifiedGallery.min.css">
        <link rel="stylesheet" href="/css/lightgallery.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext">
        <style>.bmc-button img{width: 27px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{line-height: 36px !important;height:37px !important;text-decoration: none !important;display:inline-flex !important;color:#ffffff !important;background-color:#FF813F !important;border-radius: 3px !important;border: 1px solid transparent !important;padding: 0px 9px !important;font-size: 17px !important;letter-spacing:-0.08px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Lato', sans-serif !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#ffffff !important;}</style>
        <style>.pay-button img{width: 27px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.pay-button{line-height: 36px !important;height:37px !important;text-decoration: none !important;display:inline-flex !important;color:#ffffff !important;background-color:#169BD7 !important;border-radius: 3px !important;border: 1px solid transparent !important;padding: 0px 9px !important;font-size: 17px !important;letter-spacing:-0.08px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Lato', sans-serif !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.pay-button:hover, .pay-button:active, .pay-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#ffffff !important;}</style>
    </head>
    <body>

        <script src="/js/jquery.min.js"></script>
        <script src="/js/jquery.justifiedGallery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/combine/npm/lightgallery,npm/lg-autoplay,npm/lg-fullscreen,npm/lg-hash,npm/lg-pager,npm/lg-share,npm/lg-thumbnail,npm/lg-video,npm/lg-zoom">
        </script>

        
        <div id="wrapper">

    
    
<header id="header">
    
        <h2><a href="https://davidpine.net">IEvangelist</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/blog">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/categories">
                        
                            <i class="fa fa-list-ol">&nbsp;</i>Categories
                    </a>
                </li>
            
                <li>
                    <a href="/about">
                        
                            <i class="fa fa-smile-o">&nbsp;</i>About
                    </a>
                </li>
            
                <li>
                    <a href="/speaking">
                        
                            <i class="fa fa-bullhorn">&nbsp;</i>Speaking
                    </a>
                </li>
            
                <li>
                    <a href="/media">
                        
                            <i class="fa fa-video-camera">&nbsp;</i>Media
                    </a>
                </li>
            
                <li>
                    <a href="/pictures">
                        
                            <i class="fa fa-camera">&nbsp;</i>Pictures
                    </a>
                </li>
            
                <li>
                    <a href="/conclusions">
                        
                            <i class="fa fa-lightbulb-o">&nbsp;</i>Conclusions
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:https://davidpine.net">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:https://davidpine.net">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/blog">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            <h3>
                                
                                    <i class="fa fa-list-ol">&nbsp;</i>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about">
                            <h3>
                                
                                    <i class="fa fa-smile-o">&nbsp;</i>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/speaking">
                            <h3>
                                
                                    <i class="fa fa-bullhorn">&nbsp;</i>
                                
                                Speaking
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/media">
                            <h3>
                                
                                    <i class="fa fa-video-camera">&nbsp;</i>
                                
                                Media
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/pictures">
                            <h3>
                                
                                    <i class="fa fa-camera">&nbsp;</i>
                                
                                Pictures
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/conclusions">
                            <h3>
                                
                                    <i class="fa fa-lightbulb-o">&nbsp;</i>
                                
                                Conclusions
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="https://davidpine.net/blog/asp-net-core-slack/"><p>ASP.NET Core - Slack Slash Commands</p></a>
                    </li>
                
                    <li>
                        <a href="https://davidpine.net/blog/angular-color-game/"><p>Angular - The Color Guessing Game</p></a>
                    </li>
                
                    <li>
                        <a href="https://davidpine.net/blog/csharp-all-the-things/"><p>C# All The Things</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f&text=Overriding%20ASP.NET%20Core%20Framework-Provided%20Services&via=davidpine7" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f&title=Overriding%20ASP.NET%20Core%20Framework-Provided%20Services" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f&title=Overriding%20ASP.NET%20Core%20Framework-Provided%20Services" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f&title=Overriding%20ASP.NET%20Core%20Framework-Provided%20Services" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by David%20Pine&body=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="https://davidpine.net/blog/overriding-default-di/">Overriding ASP.NET Core Framework-Provided Services</a></h1>
            
        
        
            <p>You take the red pill—you stay in Wonderland, and I show you how deep the rabbit hole goes</p>
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2017-02-14'>
            February 14, 2017</time>
        <span class="author">David Pine</span>
        
            <p>4 minute read</p>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f&text=Overriding%20ASP.NET%20Core%20Framework-Provided%20Services&via=davidpine7" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f&title=Overriding%20ASP.NET%20Core%20Framework-Provided%20Services" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f&title=Overriding%20ASP.NET%20Core%20Framework-Provided%20Services" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f&title=Overriding%20ASP.NET%20Core%20Framework-Provided%20Services" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by David%20Pine&body=https%3a%2f%2fdavidpine.net%2fblog%2foverriding-default-di%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
    
    

    
        
        




    
    
        
    


        

        <a href="https://davidpine.net/blog/overriding-default-di/" class="image featured">
            <img src="/img/2017/02/red-or-blue-pill-matrix-neo-morpheus.jpg" alt="" />
        </a>
    


    <div id="content">
        

<h1 id="overview">Overview</h1>

<p>In <strong>.NET</strong> it&rsquo;s really easy to create your own interfaces and implementations. Likewise, it&rsquo;s seemingly effortless to register them for dependency injection. But it is not always
obvious how to override existing implementations.  Let&rsquo;s discuss various aspects of &ldquo;dependency injection&rdquo; and how you can override the &ldquo;framework-provided services&rdquo;.</p>

<p>As an example, let&rsquo;s take a recent story on our product backlog for building a security audit of login attempts.  The story involved the capture of attempted usernames along
with their corresponding IP addresses.  This would allow system administrators to monitor for potential attackers. This would require our <strong>ASP.NET Core</strong> application to have
custom logging implemented.</p>

<h2 id="logging">Logging</h2>

<p>Luckily <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging" target="_blank"><code>ASP.NET Core Logging</code></a> is simple to use and is a first-class
citizen within <code>ASP.NET Core</code>.</p>

<p>In the <strong>Logging</strong> repository there is an extension method namely
<a href="https://github.com/aspnet/Logging/blob/dev/src/Microsoft.Extensions.Logging/LoggingServiceCollectionExtensions.cs" target="_blank"><code>AddLogging</code></a>, here is what it
looks like:</p>

<pre><code class="language-csharp">public static IServiceCollection AddLogging(this IServiceCollection services)
{
    if (services == null)
    {
        throw new ArgumentNullException(nameof(services));
    }

    services.TryAdd(ServiceDescriptor.Singleton&lt;ILoggerFactory, LoggerFactory&gt;());
    services.TryAdd(ServiceDescriptor.Singleton(typeof(ILogger&lt;&gt;), typeof(Logger&lt;&gt;)));

    return services;
}
</code></pre>

<p>As you can see, it is rather simple. It adds two <code>ServiceDescriptor</code> instances to the <code>IServiceCollection</code>, effectively registering the given service type to the
corresponding implementation type.</p>

<h4 id="following-the-rabbit-down-the-hole">Following the rabbit down the hole</h4>

<p>When you create a new <code>ASP.NET Core</code> project from <strong>Visual Studio</strong>, all the templates follow the same pattern. They have the <code>Program.cs</code> file with a <code>Main</code> method that looks
very similar to this:</p>

<pre><code class="language-csharp">public static void Main(string[] args)
{
    var host = new WebHostBuilder()
        .UseKestrel()
        .UseContentRoot(Directory.GetCurrentDirectory())
        .UseIISIntegration()
        .UseStartup&lt;Startup&gt;()
        .UseApplicationInsights()
        .Build();

    host.Run();
}
</code></pre>

<h6 id="templates-program-cs">Templates <code>Program.cs</code></h6>

<table>
<thead>
<tr>
<th align="center"></th>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>

<tbody>
<tr>
<td align="center"><a href="https://github.com/aspnet/Templates/blob/dev/src/BaseTemplates/EmptyWeb/Program.cs" target="_blank">Empty &nbsp; <i class="fa fa-external-link" aria-hidden="true"></i></a></td>
<td align="center"><a href="https://github.com/aspnet/Templates/blob/dev/src/BaseTemplates/StarterWeb/Program.cs" target="_blank">Starter Web &nbsp; <i class="fa fa-external-link" aria-hidden="true"></i></a></td>
<td align="center"><a href="https://github.com/aspnet/Templates/blob/dev/src/BaseTemplates/WebAPI/Program.cs" target="_blank">Web API &nbsp; <i class="fa fa-external-link" aria-hidden="true"></i></a></td>
</tr>
</tbody>
</table>

<p>One thing that is concerning about a template like this is that the <code>IWebHost</code> is an <code>IDisposable</code>, so why then is this statement not wrapped in a <code>using</code>
<a href="https://github.com/IEvangelist/Templates/commit/37e78bd0dc33069901cc51924fe8a2740d1e141c" target="_blank">you ask</a>? The answer is that the <code>Run</code> extension method
internally wraps itself in a <code>using</code>. If you were wondering where the <code>AddLogging</code> occurs, it is a result of invoking the <code>Build</code> function.</p>

<pre><code class="language-yaml">[ Microsoft.AspNetCore.Hosting.WebHostBuilder ] 
    public IWebHost Build() ...
        private IServiceCollection BuildCommonServices() ...
            creates services then invokes services.AddLogging()
</code></pre>

<h3 id="a-few-words-on-the-service-descriptor">A few words on the Service Descriptor</h3>

<p>The <code>ServiceDescriptor</code> class is an object that <em>describes</em> a <em>service</em>, and this is used by dependency injection. In other words, instances of the <code>ServiceDescriptor</code> are
descriptions of services. The <code>ServiceDescriptor</code> class exposes several static methods that allow its instantiation.</p>

<p>The <code>ILoggerFactory</code> interface is registered as a
<a href="https://github.com/aspnet/DependencyInjection/blob/dev/src/Microsoft.Extensions.DependencyInjection.Abstractions/ServiceLifetime.cs#L14" target="_blank"><code>ServiceLifetime.Singleton</code></a>
and its implementation is mapped to the <code>LoggerFactory</code>. Likewise, the generic type <code>typeof(ILogger&lt;&gt;)</code> is mapped to <code>typeof(Logger&lt;&gt;)</code>. This is just one of the several key
&ldquo;Framework-Provided Services&rdquo; that are registered.</p>

<h2 id="putting-it-together">Putting it together</h2>

<p>Now we know that the framework is providing all implementations of <code>ILogger&lt;T&gt;</code>, and resolving them as their <code>Logger&lt;T&gt;</code>. We also know that we could write our own implementation of
the <code>ILogger&lt;T&gt;</code> interface. Being that this is open-source
<a href="https://github.com/aspnet/Logging/blob/dev/src/Microsoft.Extensions.Logging.Abstractions/LoggerOfT.cs" target="_blank">we can look to their implementation</a> for inspiration.</p>

<pre><code class="language-csharp">public class RequestDetailLogger&lt;T&gt; : ILogger&lt;T&gt;
{
    private readonly ILogger _logger;

    public RequestDetailLogger(ILoggerFactory factory,
                               IRequestCategoryProvider requestCategoryProvider)
    {
        if (factory == null)
        {
            throw new ArgumentNullException(nameof(factory));
        }
        if (requestCategoryProvider == null)
        {
            throw new ArgumentNullException(nameof(requestCategoryProvider));
        }

        var category = requestDetailCategoryProvider.CreateCategory&lt;T&gt;();
        _logger = factory.CreateLogger(category);
    }

    IDisposable ILogger.BeginScope&lt;TState&gt;(TState state)
        =&gt; _logger.BeginScope(state);

    bool ILogger.IsEnabled(LogLevel logLevel)
        =&gt; _logger.IsEnabled(logLevel);

    void ILogger.Log&lt;TState&gt;(LogLevel logLevel, 
                             EventId eventId, 
                             TState state, 
                             Exception exception, 
                             Func&lt;TState, Exception, string&gt; formatter)
        =&gt; _logger.Log(logLevel, eventId, state, exception, formatter);
}
</code></pre>

<p>The <code>IRequestCategoryProvider</code> is defined and implemented as follows:</p>

<pre><code class="language-csharp">using static Microsoft.Extensions.Logging.Abstractions.Internal.TypeNameHelper;

public interface IRequestCategoryProvider
{
    string CreateCategory&lt;T&gt;();
}

public class RequestCategoryProvider : IRequestCategoryProvider
{
    private readonly IPrincipal _principal;
    private readonly IPAddress _ipAddress;

    public RequestCategoryProvider(IPrincipal principal,
                                   IPAddress ipAddress)
    {
        _principal = principal;
        _ipAddress = ipAddress;
    }

    public string CreateCategory&lt;T&gt;()
    {
        var typeDisplayName = GetTypeDisplayName(typeof(T));

        if (_principal == null || _ipAddress == null)
        {
            return typeDisplayName;
        }

        var username = _principal?.Identity?.Name;
        return $&quot;User: {username}, IP: {_ipAddress} {typeDisplayName}&quot;;
    }
}
</code></pre>

<p>If you&rsquo;re curious how to get the <code>IPrincipal</code> and <code>IPAddress</code> into this implementation (with DI) -
<a href="http://davidpine.net/blog/principal-architecture-changes/" target="_blank">I discussed it here</a> briefly. It is pretty straight-forward. In the <code>Startup.ConfigureServices</code>
method do the following:</p>

<pre><code class="language-csharp">public void ConfigureServices(IServiceCollection services)
{
    // ... omitted for brevity

    services.AddTransient&lt;IRequestCategoryProvider, RequestCategoryProvider&gt;();
    services.AddTransient&lt;IHttpContextAccessor, HttpContextAccessor&gt;();
    services.AddTransient&lt;IPrincipal&gt;(
        provider =&gt; provider.GetService&lt;IHttpContextAccessor&gt;()
                           ?.HttpContext
                           ?.User);
    services.AddTransient&lt;IPAddress&gt;(
        provider =&gt; provider.GetService&lt;IHttpContextAccessor&gt;()
                           ?.HttpContext
                           ?.Connection
                           ?.RemoteIpAddress);
}
</code></pre>

<p>Finally, we can
<a href="https://github.com/aspnet/DependencyInjection/blob/dev/src/Microsoft.Extensions.DependencyInjection.Abstractions/Extensions/ServiceCollectionDescriptorExtensions.cs"
   target="_blank"><code>Replace</code></a> the implementations for the <code>ILogger&lt;T&gt;</code> by using the following:</p>

<pre><code class="language-csharp">public void ConfigureServices(IServiceCollection services)
{
    // ... omitted for brevity
    services.Replace(ServiceDescriptor.Transient(typeof(ILogger&lt;&gt;), 
                                                 typeof(RequestDetailLogger&lt;&gt;)));
}
</code></pre>

<p>Notice that we replace the framework-provided service as a <code>ServiceLifetime.Transient</code>. Opposed to the default <code>ServiceLifetime.Singleton</code>. This is more or less an extra
precaution. We know that with each request we get the <code>HttpContext</code> from the <code>IHttpContextAccessor</code>, and from this we have the <code>User</code>. This is what is passed to each
<code>ILogger&lt;T&gt;</code>.</p>

<h1 id="conclusion">Conclusion</h1>

<p>This approach is valid for overriding any of the various framework-provided service implementations. It is simply a matter of knowing the correct <code>ServiceLifetime</code> for your
specific needs. Likewise, it is a good idea to leverage the open-source libraries of the framework for inspiration. With this you can take finite control of your web-stack.</p>

<h1 id="further-reading">Further Reading</h1>

<ul>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection" target="_blank">
<i class="fa fa-file-text-o" aria-hidden="true"></i> <code>ASP.NET Core - Dependency Injection</code>
</a></li>
</ul>

    </div>

    <footer>
        <ul class="stats">
    <li>
        <i class="fa fa-list-ol">&nbsp;</i>
        Categories
    </li>
    
        
        
            
            
            <li><a class="article-category-link" href="https://davidpine.net/categories/asp.net-core">ASP.NET Core</a></li>
            
            
            <li><a class="article-category-link" href="https://davidpine.net/categories/.net-core">.NET Core</a></li>
            
            
            <li><a class="article-category-link" href="https://davidpine.net/categories/dependency-injection">Dependency Injection</a></li>
            
        
    
</ul>
    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="https://davidpine.net/blog/principal-architecture-changes/"
                class="button big previous">What happened to my Thread.CurrentPrincipal</a></li>
    

    
        <li><a href="https://davidpine.net/blog/exploring-csharp-seven/"
                class="button big next">Exploring C# 7</a></li>
    
</ul>



    
        <article class="post">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "davidpine" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>
    


    </div>
    
<section id="sidebar">

    
    <section id="intro">
        
        
        
        <img src="/img/main/me.png" class="intro-circle" width="" alt="David Pine" />
        
        
        
        <header>
            <h2>David Pine</h2>
            <p>Technical Evangelist, with a goal of changing the world - one line of code at a time <i class='fa fa-code' aria-hidden='true'></i></p>
        </header>
        

        <div class="row">
            <div class="column">
                <a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/davidpine">
                    <img src="https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg" alt="Buy me a coffee">
                    <span style="margin-left:5px">Buy me a coffee</span>
                </a>
            </div>
            <div class="column">
                <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
                    <input type="hidden" name="cmd" value="_donations" />
                    <input type="hidden" name="business" value="SL3B2ZGL6APL4" />
                    <input type="hidden" name="currency_code" value="USD" />
                    <button type="submit" class="pay-button" style="text-transform: none; font-weight: 400">
                        <input type="image" src="/img/paypal.svg" height="30px" border="0" id="img" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
                        <span style="margin-left:5px; ">Support my blog</span>
                    </button>
                    <img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1" />
                </form>
            </div>
        </div>

        <div class='row'>
            <div class='column'>
                <a target="_blank" rel="noopener" href="https://mvp.microsoft.com/en-us/publicprofile/5002736">
                    <img src="/img/main/mvp-v.png" width="160px" />
                </a>
            </div>
            <div class='column'>
                <a target="_blank" rel="noopener" href="https://google-developers.appspot.com/community/experts/directory/profile/profile-david_pine">
                    <img src="/img/main/gde.png" width="210px" />
                </a>
            </div>
        </div>

        <hr />

        <ul class="icons">
            
            
            
<li><a href="//github.com/IEvangelist" target="_blank" title="GitHub" class="fa-lg fa-github"></a></li>



<li><a href="//papercall.io/speakers/david-pine" target="_blank" title="PaperCall" class="fa-lg fa-paper-plane-o"></a></li>







<li><a href="//codepen.io/ievangelist" target="_blank" title="CodePen" class="fa-lg fa-codepen"></a></li>















<li><a href="//youtube.com/user/davidpine7" target="_blank" title="YouTube" class="fa-lg fa-youtube"></a></li>







<li><a href="//medium.com/@davidpine7" target="_blank" title="Medium" class="fa-lg fa-medium"></a></li>



<li><a href="//ievangelistblog.wordpress.com" target="_blank" title="WordPress" class="fa-lg fa-wordpress"></a></li>







<li><a href="//linkedin.com/in/dpine" target="_blank" title="LinkedIn" class="fa-lg fa-linkedin"></a></li>





<li><a href="//stackoverflow.com/users/2410379/david-pine" target="_blank" title="Stack Overflow" class="fa-lg fa-stack-overflow"></a></li>



<li><a href="//reddit.com/user/davidpine7" target="_blank" title="Reddit" class="fa-lg fa-reddit"></a></li>









<li><a href="//twitter.com/davidpine7" target="_blank" title="Twitter" class="fa-lg fa-twitter"></a></li>



<li><a href="mailto:david.pine.7@gmail.com" title="Email" class="fa-lg fa-envelope"></a></li>


            
        </ul>
    </section>

    
    <section id="recent-posts">
        <ul class="posts">
            <header>
                <h3>Recent Posts</h3>
            </header>
            
            
            

            
            
            

            
            <li>
                <article>
                    <header>
                        <h3><a href="https://davidpine.net/blog/asp-net-core-slack/">ASP.NET Core - Slack Slash Commands</a></h3>
                        
                        
                        
                        <time class="published" datetime='2019-03-21'>
                            March 21, 2019</time>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <h3><a href="https://davidpine.net/blog/angular-color-game/">Angular - The Color Guessing Game</a></h3>
                        
                        
                        
                        <time class="published" datetime='2019-03-14'>
                            March 14, 2019</time>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <h3><a href="https://davidpine.net/blog/csharp-all-the-things/">C# All The Things</a></h3>
                        
                        
                        
                        <time class="published" datetime='2018-12-16'>
                            December 16, 2018</time>
                    </header>
                </article>
            </li>
            

            
            <li>
                <ul class="actions">
                    <li><a href= /blog/  class="button">View
                            more posts</a></li>
                </ul>
            </li>
            
        </ul>
    </section>

    
    
    
    
    <section id="categories">
        <ul class="posts">
            <header>
                <h3><a href="/categories/">Categories</a></h3>
            </header>

            
            
            

            
            <li>
                <article>
                    <header>
                        <a href="/categories/csharp/">csharp</a>
                        <span style="float:right;">11</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/asp.net-core/">asp.net-core</a>
                        <span style="float:right;">10</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/.net-core/">.net-core</a>
                        <span style="float:right;">7</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/angular/">angular</a>
                        <span style="float:right;">5</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/typescript/">typescript</a>
                        <span style="float:right;">5</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/.net/">.net</a>
                        <span style="float:right;">4</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/rxjs/">rxjs</a>
                        <span style="float:right;">4</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/visual-studio/">visual-studio</a>
                        <span style="float:right;">4</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/http/">http</a>
                        <span style="float:right;">2</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/technical-conference/">technical-conference</a>
                        <span style="float:right;">2</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/tooling/">tooling</a>
                        <span style="float:right;">2</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/wasm/">wasm</a>
                        <span style="float:right;">2</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/webassembly/">webassembly</a>
                        <span style="float:right;">2</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/xunit/">xunit</a>
                        <span style="float:right;">2</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/.net-standard/">.net-standard</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/azure/">azure</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/blazor/">blazor</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/caching/">caching</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/compression/">compression</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/configuration/">configuration</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/dependency-injection/">dependency-injection</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/fear/">fear</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/gzip/">gzip</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/identity/">identity</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/iot/">iot</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/javascript/">javascript</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/json/">json</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/mke-dot-net/">mke-dot-net</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/raspberry-pi/">raspberry-pi</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/roslyn/">roslyn</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/self-branding/">self-branding</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/slack/">slack</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/technical-doubt/">technical-doubt</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/twilio/">twilio</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/uwp/">uwp</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
            <li>
                <article>
                    <header>
                        <a href="/categories/web/">web</a>
                        <span style="float:right;">1</span>
                    </header>
                </article>
            </li>
            
        </ul>
    </section>
    

    
    

    
    <section id="footer">
        <ul class="icons">
            
            
            
<li><a href="//github.com/IEvangelist" target="_blank" title="GitHub" class="fa-lg fa-github"></a></li>



<li><a href="//papercall.io/speakers/david-pine" target="_blank" title="PaperCall" class="fa-lg fa-paper-plane-o"></a></li>







<li><a href="//codepen.io/ievangelist" target="_blank" title="CodePen" class="fa-lg fa-codepen"></a></li>















<li><a href="//youtube.com/user/davidpine7" target="_blank" title="YouTube" class="fa-lg fa-youtube"></a></li>







<li><a href="//medium.com/@davidpine7" target="_blank" title="Medium" class="fa-lg fa-medium"></a></li>



<li><a href="//ievangelistblog.wordpress.com" target="_blank" title="WordPress" class="fa-lg fa-wordpress"></a></li>







<li><a href="//linkedin.com/in/dpine" target="_blank" title="LinkedIn" class="fa-lg fa-linkedin"></a></li>





<li><a href="//stackoverflow.com/users/2410379/david-pine" target="_blank" title="Stack Overflow" class="fa-lg fa-stack-overflow"></a></li>



<li><a href="//reddit.com/user/davidpine7" target="_blank" title="Reddit" class="fa-lg fa-reddit"></a></li>









<li><a href="//twitter.com/davidpine7" target="_blank" title="Twitter" class="fa-lg fa-twitter"></a></li>



<li><a href="mailto:david.pine.7@gmail.com" title="Email" class="fa-lg fa-envelope"></a></li>


            
        </ul>

        <p class="copyright">&copy; IEvangelist 2016. Powered by <a href="//gohugo.io" target="_blank">Hugo</a></p>
    </section>

</section>
            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

